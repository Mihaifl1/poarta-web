<!doctype html>
<html lang="ro">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Poartă – Control & Calibrare</title>
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<style>
  body{font-family:Arial, sans-serif; background:#0b1220; color:#fff; margin:0;}
  .tabbar{display:flex; background:#071022; position:sticky; top:0;}
  .tabbtn{flex:1;padding:12px;border:none;background:#071022;color:#9fb0d8;font-size:16px;font-weight:bold;cursor:pointer}
  .tabbtn.active{background:#123;color:#fff}
  .tab{display:none;padding:20px}
  .status{margin:20px;font-size:18px}
  .btn{margin:8px;padding:12px 20px;border:none;border-radius:8px;font-size:16px;cursor:pointer}
  .open{background:#1f6d3a;color:white}
  .close{background:#7a1f1f;color:white}
  .stop{background:#6a5b18;color:white}
  progress{width:80%;height:20px}
  .pill{padding:3px 10px;border-radius:12px}
  .on{background:#1f6d3a} .off{background:#7a1f1f}
</style>
</head>
<body>

<div class="tabbar">
  <button class="tabbtn active" onclick="showTab('control')" id="btnControl">Control</button>
  <button class="tabbtn" onclick="showTab('calib')" id="btnCalib">Calibrare</button>
</div>

<!-- TAB CONTROL -->
<div class="tab" id="tabControl" style="display:block">
  <h2>Control Poartă (MQTT)</h2>
  <div class="status">Stare: <span id="status">necunoscut</span></div>
  <div>Progres: <span id="progVal">0%</span></div>
  <progress id="prog" value="0" max="100"></progress>
  <br>
  <button class="btn open" onclick="publishCmd('OPEN')">Deschide</button>
  <button class="btn close" onclick="publishCmd('CLOSE')">Închide</button>
  <button class="btn stop" onclick="publishCmd('STOP')">Stop</button>
</div>

<!-- TAB CALIBRARE -->
<div class="tab" id="tabCalib">
  <h2>Calibrare Poartă (REST către ESP)</h2>
  <label>ESP URL: <input id="espUrl" value="http://esp.local" style="width:200px"></label>

  <div>Stare: <b id="st">—</b></div>
  <div>Progres: <b id="pr">0%</b></div>
  <progress id="pg" value="0" max="100"></progress>
  <div>Senzor OPEN: <span id="so" class="pill off">OFF</span> • Senzor CLOSED: <span id="sc" class="pill off">OFF</span></div>

  <h3>Calibrare OPEN</h3>
  <div>Timp măsurat: <b id="mo">—</b> ms</div>
  <button class="btn open" onclick="calibStart('open')">Start</button>
  <button class="btn" onclick="saveCalib('open')">Save OPEN</button>

  <h3>Calibrare CLOSE</h3>
  <div>Timp măsurat: <b id="mc">—</b> ms</div>
  <button class="btn open" onclick="calibStart('close')">Start</button>
  <button class="btn" onclick="saveCalib('close')">Save CLOSE</button>

  <h3>Comenzi directe</h3>
  <button class="btn open" onclick="sendCmd('OPEN')">Deschide</button>
  <button class="btn close" onclick="sendCmd('CLOSE')">Închide</button>
  <button class="btn stop" onclick="sendCmd('STOP')">Stop</button>
</div>

<script>
/* Tabs */
function showTab(which){
  document.getElementById("tabControl").style.display = (which==="control")?"block":"none";
  document.getElementById("tabCalib").style.display   = (which==="calib")?"block":"none";
  document.getElementById("btnControl").classList.toggle("active",which==="control");
  document.getElementById("btnCalib").classList.toggle("active",which==="calib");
}

/* MQTT – Control */
const mqttUrl = "wss://broker.emqx.io:8084/mqtt";
const cmdTopic = "kablem/gates/1/cmd";
const statusTopic = "kablem/gates/1/status";
const progressTopic = "kablem/gates/1/progress";

let client = mqtt.connect(mqttUrl,{clientId:"web_"+Math.random().toString(16).slice(2)});
client.on("connect",()=>{ client.subscribe([statusTopic,progressTopic]); client.publish(cmdTopic,"STATUS?"); });
client.on("message",(topic,payload)=>{
  const msg=payload.toString();
  if(topic===statusTopic) document.getElementById("status").textContent=msg;
  if(topic===progressTopic){
    let val=parseInt(msg)||0;
    document.getElementById("prog").value=val;
    document.getElementById("progVal").textContent=val+"%";
  }
});
function publishCmd(c){ client.publish(cmdTopic,c); }

/* REST – Calibrare */
function esp(){ let u=document.getElementById("espUrl").value.trim(); if(!/^http/.test(u)) u="http://"+u; return u; }
async function tick(){
  try{
    let r=await fetch(esp()+"/api/state"); let j=await r.json();
    document.getElementById("st").textContent=j.state;
    document.getElementById("pr").textContent=j.progress+"%";
    document.getElementById("pg").value=j.progress;
    document.getElementById("so").className="pill "+(j.openLimit?"on":"off");
    document.getElementById("so").textContent=j.openLimit?"ON":"OFF";
    document.getElementById("sc").className="pill "+(j.closedLimit?"on":"off");
    document.getElementById("sc").textContent=j.closedLimit?"ON":"OFF";
    document.getElementById("mo").textContent=(j.measOpenMs>=0)?j.measOpenMs:"—";
    document.getElementById("mc").textContent=(j.measCloseMs>=0)?j.measCloseMs:"—";
  }catch(e){}
}
setInterval(tick,1000);

async function calibStart(dir){ await fetch(esp()+"/api/calib_start?dir="+dir); }
async function saveCalib(dir){ await fetch(esp()+"/api/calib_save?dir="+dir); }
async function sendCmd(c){ await fetch(esp()+"/api/cmd?c="+c); }
</script>
</body>
</html>
